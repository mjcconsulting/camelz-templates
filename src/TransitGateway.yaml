AWSTemplateFormatVersion: 2010-09-09
Description: TransitGateway Template.
  This template creates a TransitGateway.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Stack Dependencies
        Parameters:
          - ReferenceFunctionsStackName
      - Label:
          default: System Configuration
        Parameters:
          - CompanyName
          - SystemName
      - Label:
          default: Environment Configuration
        Parameters:
          - AccountName
          - EnvironmentName
      - Label:
          default: TransitGateway Configuration
        Parameters:
          - TransitGatewayAccountId
          - TransitGatewayASN
          - AutoAcceptSharedAttachments
          - DnsSupport
          - VpnEcmpSupport
      - Label:
          default: ResourceShare Configuration
        Parameters:
          - TransitGatewayResourceShareName
          - OrganizationId
          - AllowExternalPrincipals
      - Label:
          default: Account Dependencies
        Parameters:
          - OrganizationAccountId
          - JumpstartAccountId
          - ManagementAccountId
          - CoreAccountId
          - LogAccountId
          - BuildAccountId
          - ProductionAccountId
          - NonProductionAccountId
          - RecoveryAccountId
          - StagingAccountId
          - UATAccountId
          - QAAccountId
          - TestingAccountId
          - DevelopmentAccountId
    ParameterLabels:
      ReferenceFunctionsStackName:
        default: ReferenceFunctions Stack Name
      CompanyName:
        default: Company Name
      SystemName:
        default: System Name
      AccountName:
        default: Account Name
      EnvironmentName:
        default: Environment Name
      TransitGatewayAccountId:
        default: TransitGateway Account ID
      TransitGatewayASN:
        default: TransitGateway ASN
      AutoAcceptSharedAttachments:
        default: Auto-Accept Shared Attachments
      DnsSupport:
        default: DNS Support
      VpnEcmpSupport:
        default: VPN ECMP Support
      TransitGatewayResourceShareName:
        default: TransitGateway ResourceShare Name
      OrganizationId:
        default: Organization ID
      AllowExternalPrincipals:
        default: Allow External Principals
      OrganizationAccountId:
        default: Organization Account ID
      JumpstartAccountId:
        default: Jumpstart Account ID
      ManagementAccountId:
        default: Management Account ID
      CoreAccountId:
        default: Core Account ID
      LogAccountId:
        default: Log Account ID
      BuildAccountId:
        default: Build Account ID
      ProductionAccountId:
        default: Production Account ID
      NonProductionAccountId:
        default: NonProduction Account ID
      RecoveryAccountId:
        default: Recovery Account ID
      StagingAccountId:
        default: Staging Account ID
      UATAccountId:
        default: UAT Account ID
      QAAccountId:
        default: QA Account ID
      TestingAccountId:
        default: Testing Account ID
      DevelopmentAccountId:
        default: Development Account ID
Parameters:
  ReferenceFunctionsStackName:
    Description: Name of the CloudFormation Stack containing the Reference Functions
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: ReferenceFunctions
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  CompanyName:
    Description: Name of the Company associated with the Stack
    Type: String
    MinLength: 2
    MaxLength: 32
    Default: Camelz
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  SystemName:
    Description: Name of the System associated with the Stack
    Type: String
    MinLength: 2
    MaxLength: 32
    Default: Prototype
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  AccountName:
    Description: Name of the Account associated with the Stack
    Type: String
    Default: Core
    AllowedValues:
      - Organization
      - Jumpstart
      - Management
      - Core
      - Log
      - Build
      - Production
      - NonProduction
      - Recovery
      - Staging
      - UAT
      - QA
      - Testing
      - Development
    ConstraintDescription: must be Organization, Jumpstart, Management, Core, Log, Build, Production, NonProduction, Recovery, Staging, UAT, QA, Testing or Development.
  EnvironmentName:
    Description: Name of the Environment associated with the Stack
    Type: String
    Default: Core
    AllowedValues:
      - Organization
      - Jumpstart
      - Management
      - Core
      - Log
      - Build
      - Production
      - NonProduction
      - Recovery
      - Staging
      - UAT
      - QA
      - Testing
      - Development
    ConstraintDescription: must be Organization, Jumpstart, Management, Core, Log, Build, Production, NonProduction, Recovery, Staging, UAT, QA, Testing or Development.
  TransitGatewayAccountId:
    Description: AWS Account ID of the Account where TransitGateway should be created.
      All other accounts will attempt to share the TransitGateway created in this Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  TransitGatewayASN:
    Description: Autonomous System Number for the TransitGateway
    Type: Number
    Default: 64512
    MinValue: 64512
    MaxValue: 65534
    ConstraintDescription: must be an integer between 64512 and 65534.
  AutoAcceptSharedAttachments:
    Description: Automatically accept attachment requests
    Type: String
    Default: enable
    AllowedValues:
      - enable
      - disable
    ConstraintDescription: must be either enable or disable.
  DnsSupport:
    Description: Support DNS
    Type: String
    Default: enable
    AllowedValues:
      - enable
      - disable
    ConstraintDescription: must be either enable or disable.
  VpnEcmpSupport:
    Description: Support Equal Cost Multipath Protocol on VPN Connections
    Type: String
    Default: enable
    AllowedValues:
      - enable
      - disable
    ConstraintDescription: must be either enable or disable.
  TransitGatewayResourceShareName:
    Description: Name of the ResourceShare associated with the shared TransitGateway created in another Account
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: TransitGatewayResourceShare
    AllowedPattern: ^TransitGatewayResourceShare$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  OrganizationId:
    Description: AWS Organization ID
    Type: String
    Default: ''
    AllowedPattern: (^$|^o-[0-9a-z]{10}$)
    ConstraintDescription: must be a valid AWS Organization ID, or blank.
  AllowExternalPrincipals:
    Description: Allow External Principals (Specifying any Account will force this to true)
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be either true or false.
  OrganizationAccountId:
    Description: AWS Account ID of the Organization Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  JumpstartAccountId:
    Description: AWS Account ID of the Jumpstart Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  ManagementAccountId:
    Description: AWS Account ID of the Management Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  CoreAccountId:
    Description: AWS Account ID of the Core Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  LogAccountId:
    Description: AWS Account ID of the Log Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  BuildAccountId:
    Description: AWS Account ID of the Build Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  ProductionAccountId:
    Description: AWS Account ID of the Production Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  NonProductionAccountId:
    Description: AWS Account ID of the NonProduction Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  RecoveryAccountId:
    Description: AWS Account ID of the Recovery Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  StagingAccountId:
    Description: AWS Account ID of the Staging Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  UATAccountId:
    Description: AWS Account ID of the UAT Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  QAAccountId:
    Description: AWS Account ID of the QA Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  TestingAccountId:
    Description: AWS Account ID of the Testing Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
  DevelopmentAccountId:
    Description: AWS Account ID of the Development Account
    Type: String
    Default: ''
    AllowedPattern: (^$|^[0-9]{12}$)
    ConstraintDescription: must be a valid AWS Account ID, or blank.
Rules:
  ValidateOrganizationAccountId:
    RuleCondition: !Not [ !Equals [ !Ref OrganizationId, '' ]]
    Assertions:
      - Assert: !Not [ !Equals [ !Ref OrganizationAccountId, '' ]]
        AssertDescription: OrganizationAccountId required when OrganizationId is specified.
Conditions:
  CreateTransitGateway: !Or [ !Equals [ !Ref TransitGatewayAccountId, '' ],
                              !Equals [ !Ref TransitGatewayAccountId, 'AWS::AccountId' ]]
  ShareTransitGateway: !Not [ !Condition CreateTransitGateway ]
  ConfigureOrganization: !Not [ !Equals [ !Ref OrganizationId, '' ]]
  ConfigureOrganizationAccount: !And [ !Not [ !Equals [ !Ref OrganizationAccountId, '' ]],
                                       !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureJumpstartAccount: !And [ !Not [ !Equals [ !Ref JumpstartAccountId, '' ]],
                                    !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureManagementAccount: !And [ !Not [ !Equals [ !Ref ManagementAccountId, '' ]],
                                     !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureCoreAccount: !And [ !Not [ !Equals [ !Ref CoreAccountId, '' ]],
                               !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureLogAccount: !And [ !Not [ !Equals [ !Ref LogAccountId, '' ]],
                              !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureBuildAccount: !And [ !Not [ !Equals [ !Ref BuildAccountId, '' ]],
                                !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureProductionAccount: !And [ !Not [ !Equals [ !Ref ProductionAccountId, '' ]],
                                     !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureNonProductionAccount: !And [ !Not [ !Equals [ !Ref NonProductionAccountId, '' ]],
                                        !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureRecoveryAccount: !And [ !Not [ !Equals [ !Ref RecoveryAccountId, '' ]],
                                   !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureStagingAccount: !And [ !Not [ !Equals [ !Ref StagingAccountId, '' ]],
                                  !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureUATAccount: !And [ !Not [ !Equals [ !Ref UATAccountId, '' ]],
                              !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureQAAccount: !And [ !Not [ !Equals [ !Ref QAAccountId, '' ]],
                             !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureTestingAccount: !And [ !Not [ !Equals [ !Ref TestingAccountId, '' ]],
                                  !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
  ConfigureDevelopmentAccount: !And [ !Not [ !Equals [ !Ref DevelopmentAccountId, '' ]],
                                      !Not [ !Equals [ !Ref CoreAccountId, 'AWS::AccountId' ]]]
Resources:
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: !Sub ${EnvironmentName}-TransitGateway
      AmazonSideAsn: !Ref TransitGatewayASN
      AutoAcceptSharedAttachments: !Ref AutoAcceptSharedAttachments
      DefaultRouteTableAssociation: enable
      DefaultRouteTablePropagation: enable
      DnsSupport: !Ref DnsSupport
      VpnEcmpSupport: !Ref VpnEcmpSupport
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-TransitGateway
    Condition: CreateTransitGateway
  TransitGatewayResourceShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      Name: !Ref TransitGatewayResourceShareName
      AllowExternalPrincipals: !Ref AllowExternalPrincipals
      ResourceArns:
        - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:transit-gateway/${TransitGateway}
      Principals:
        - !If
            - ConfigureOrganization
            - !Sub arn:aws:organizations::${OrganizationAccountId}:organization/${OrganizationId}
            - !If [ ConfigureOrganizationAccount, !Ref OrganizationAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureJumpstartAccount, !Ref JumpstartAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureManagementAccount, !Ref ManagementAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureCoreAccount, !Ref CoreAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureLogAccount, !Ref LogAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureBuildAccount, !Ref BuildAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureProductionAccount, !Ref ProductionAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureNonProductionAccount, !Ref NonProductionAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureRecoveryAccount, !Ref RecoveryAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureStagingAccount, !Ref StagingAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureUATAccount, !Ref UATAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureTestingAccount, !Ref TestingAccountId, !Ref 'AWS::NoValue' ]
        - !If [ ConfigureDevelopmentAccount, !Ref DevelopmentAccountId, !Ref 'AWS::NoValue' ]
      Tags:
       - Key: Name
         Value: !Sub ${EnvironmentName}-TransitGatewayResourceShare
    Condition: CreateTransitGateway
  TransitGatewayReference:
    Type: Custom::TransitGatewayReference
    Properties:
      ServiceToken: !ImportValue
        Fn::Sub: ${ReferenceFunctionsStackName}-TransitGatewayReferenceFunctionArn
      ResourceShareName: !Ref TransitGatewayResourceShareName
      SenderAccountId: !Ref TransitGatewayAccountId
    Condition: ShareTransitGateway
Outputs:
  TransitGateway:
    Description: The TransitGateway
    Value: !If [ CreateTransitGateway, !Ref TransitGateway, !Ref TransitGatewayReference ]
    Export:
      Name: !Sub ${AWS::StackName}-TransitGateway
