AWSTemplateFormatVersion: 2010-09-09
2	Description: Application-MariaDB-Database Template.
3	  This template implements an MariaDB (MySQL) RDS Database and related resources.
4	Metadata:
5	  AWS::CloudFormation::Interface:
6	    ParameterGroups:
7	      - Label:
8	          default: Stack Dependencies
9	        Parameters:
10	          - WindowsBastionsStackName
11	          - DirectoryStackName
12	          - VPCStackName
13	          - BucketsStackName
14	          - TopicsStackName
15	          - KeysStackName
16	          - CodesStackName
17	      - Label:
18	          default: System Configuration
19	        Parameters:
20	          - CompanyName
21	          - SystemName
22	      - Label:
23	          default: Environment Configuration
24	        Parameters:
25	          - AccountName
26	          - EnvironmentName
27	          - EnvironmentType
28	          - EnvironmentZones
29	      - Label:
30	          default: MariaDB Application Configuration
31	        Parameters:
32	          - MariaDBApplicationName
33	          - DatabaseComponentName
34	          - MariaDBDatabaseServiceName
35	      - Label:
36	          default: Engine Configuration
37	        Parameters:
38	          - EngineType
39	          - AllocatedStorage
40	          - DBInstanceClass
41	          - EngineMode
42	          - EngineVersion
43	          - EncryptionType
44	          - BackupRetention
45	          - BackupWindow
46	          - MaintenanceWindow
47	          - LogRetention
48	      - Label:
49	          default: MariaDB Database Configuration
50	        Parameters:
51	          - MariaDBMasterUserName
52	          - MariaDBMasterUserPassword
53	          - MariaDBDatabaseName
54	      - Label:
55	          default: Security Configuration
56	        Parameters:
57	          - AdministratorNetworks
58	          - AdministratorNetworkDescriptions
59	    ParameterLabels:
60	      WindowsBastionsStackName:
61	        default: WindowsBastions Stack Name
62	      DirectoryStackName:
63	        default: Directory Stack Name
64	      VPCStackName:
65	        default: VPC Stack Name
66	      BucketsStackName:
67	        default: Buckets Stack Name
68	      TopicsStackName:
69	        default: Topics Stack Name
70	      KeysStackName:
71	        default: Keys Stack Name
72	      CodesStackName:
73	        default: Codes Stack Name
74	      CompanyName:
75	        default: Company Name
76	      SystemName:
77	        default: System Name
78	      AccountName:
79	        default: Account Name
80	      EnvironmentName:
81	        default: Environment Name
82	      EnvironmentType:
83	        default: Environment Type
84	      EnvironmentZones:
85	        default: Environment Zones
86	      MariaDBApplicationName:
87	        default: MariaDB Application Name
88	      DatabaseComponentName:
89	        default: Database Component Name
90	      MariaDBDatabaseServiceName:
91	        default: MariaDB-Database DNS Service Name
92	      EngineType:
93	        default: Engine Type
94	      AllocatedStorage:
95	        default: Allocated Storage
96	      DBInstanceClass:
97	        default: DB Instance Class
98	      EngineMode:
99	        default: Engine Mode
100	      EngineVersion:
101	        default: Engine Version
102	      EncryptionType:
103	        default: Encryption Type
104	      BackupRetention:
105	        default: Backup Retention
106	      BackupWindow:
107	        default: Backup Window
108	      MaintenanceWindow:
109	        default: Maintenance Window
110	      LogRetention:
111	        default: Log Retention
112	      MariaDBMasterUserName:
113	        default: MariaDB Master User Name
114	      MariaDBMasterUserPassword:
115	        default: MariaDB Master User Password
116	      MariaDBDatabaseName:
117	        default: MariaDB Database Name
118	      AdministratorNetworks:
119	        default: Administrator Networks
120	      AdministratorNetworkDescriptions:
121	        default: Administrator Network Descriptions
122	Parameters:
123	  WindowsBastionsStackName:
124	    Description: Name of the CloudFormation Stack containing the Windows Bastions
125	    Type: String
126	    MaxLength: 64
127	    Default: UAT-WindowsBastions
128	    AllowedPattern: (^$|^[A-Z][-a-zA-Z0-9]*$)
129	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
130	  DirectoryStackName:
131	    Description: Name of the CloudFormation Stack containing the Directory Management Workstation (DirectoryService) or DomainControllers (ActiveDirectory)
132	    Type: String
133	    MaxLength: 64
134	    Default: UAT-ActiveDirectory
135	    AllowedPattern: (^$|^[A-Z][a-zA-Z0-9]*-(ActiveDirectory|DirectoryService)$)
136	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
137	  VPCStackName:
138	    Description: Name of the CloudFormation Stack containing the VPC
139	    Type: String
140	    MinLength: 2
141	    MaxLength: 64
142	    Default: UAT-VPC
143	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
144	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
145	  BucketsStackName:
146	    Description: Name of the CloudFormation Stack containing Buckets
147	    Type: String
148	    MinLength: 2
149	    MaxLength: 64
150	    Default: Buckets
151	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
152	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
153	  TopicsStackName:
154	    Description: Name of the CloudFormation Stack containing Topics
155	    Type: String
156	    MinLength: 2
157	    MaxLength: 64
158	    Default: Topics
159	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
160	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
161	  KeysStackName:
162	    Description: Name of the CloudFormation Stack containing Keys
163	    Type: String
164	    MinLength: 2
165	    MaxLength: 64
166	    Default: Keys
167	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
168	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
169	  CodesStackName:
170	    Description: Name of the CloudFormation Stack containing the Codes Resources
171	    Type: String
172	    MinLength: 2
173	    MaxLength: 64
174	    Default: Codes
175	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
176	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
177	  CompanyName:
178	    Description: Name of the Company associated with the Stack
179	    Type: String
180	    MinLength: 2
181	    MaxLength: 32
182	    Default: DXC
183	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
184	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
185	  SystemName:
186	    Description: Name of the System associated with the Stack
187	    Type: String
188	    MinLength: 2
189	    MaxLength: 32
190	    Default: Prototype
191	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
192	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
193	  AccountName:
194	    Description: Name of the Account associated with the Stack
195	    Type: String
196	    Default: UAT
197	    AllowedValues:
198	      - Production
199	      - Staging
200	      - UAT
201	      - QA
202	      - Testing
203	      - Development
204	      - Build
205	      - Core
206	      - Recovery
207	      - Log
208	      - Management
209	      - Jumpstart
210	      - Organization
211	    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Management, Jumpstart or Organization.
212	  EnvironmentName:
213	    Description: Name of the Environment associated with the Stack
214	    Type: String
215	    Default: UAT
216	    AllowedValues:
217	      - Production
218	      - Staging
219	      - UAT
220	      - QA
221	      - Testing
222	      - Development
223	      - Build
224	      - Core
225	      - Recovery
226	      - Log
227	      - Identity
228	      - Management
229	      - Organization
230	    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Identity, Management or Organization.
231	  EnvironmentType:
232	    Description: Type of the Environment to build. Used to select size-related options in Mappings
233	    Type: String
234	    Default: large
235	    AllowedValues:
236	      - small
237	      - medium
238	      - large
239	      - xlarge
240	      - 2xlarge
241	      - 4xlarge
242	      - 8xlarge
243	    ConstraintDescription: must be small, medium, large, xlarge, 2xlarge, 4xlarge or 8xlarge.
244	  EnvironmentZones:
245	    Description: Number of Availability Zones to build
246	    Type: String
247	    Default: 2
248	    AllowedValues:
249	      - 1
250	      - 2
251	    ConstraintDescription: must be 1 or 2.
252	  MariaDBApplicationName:
253	    Description: Name of the MariaDB Application
254	    Type: String
255	    MinLength: 2
256	    MaxLength: 32
257	    Default: MariaDB
258	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
259	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
260	  DatabaseComponentName:
261	    Description: Name of the Database Component
262	    Type: String
263	    Default: Database
264	    AllowedValues:
265	      - Database
266	    ConstraintDescription: must be Database.
267	  MariaDBDatabaseServiceName:
268	    Description: DNS Service Name of the MariaDB-Database Application Component
269	    Type: String
270	    MinLength: 2
271	    MaxLength: 64
272	    Default: mariadb-db
273	    AllowedPattern: ^[a-z][-a-z0-9]*$
274	    ConstraintDescription: must begin with a lower case letter and contain only lower case letters and dashes.
275	  EngineType:
276	    Description: Type of Database Engine
277	    Type: String
278	    Default: MariaDB
279	    AllowedValues:
280	      - MariaDB
281	    ConstraintDescription: must be MariaDB.
282	  AllocatedStorage:
283	    Description: Storage Allocated to Database
284	    Type: String
285	    Default: 100
286	    AllowedValues:
287	      - 100
288	      - 1,000
289	    ConstraintDescription: must be 100 or 1,000.
290	  DBInstanceClass:
291	    Description: The compute and memory capacity of the DB instance
292	    Type: String
293	    Default: db.r5.large
294	    AllowedValues:
295	      - db.r5.large
296	    ConstraintDescription: must be db.m4.large.
297	  EngineMode:
298	    Description: Mode of Database Engine
299	    Type: String
300	    Default: provisioned
301	    AllowedValues:
302	      - provisioned
303	      - parallelquery
304	      - serverless
305	    ConstraintDescription: must be provisioned, parallelquery or serverless.
306	  EngineVersion:
307	    Description: Version of the Database Engine
308	    Type: String
309	    Default: 10.3
310	    AllowedValues:
311	      - 10.3
312	    ConstraintDescription: must be 10.3.
313	  EncryptionType:
314	    Description: Type of Encryption
315	    Type: String
316	    Default: default
317	    AllowedValues:
318	      - default
319	      - custom
320	      - none
321	    ConstraintDescription: must be default, custom or none.
322	  BackupRetention:
323	    Description: Number of days to retain automated database backups
324	    Type: Number
325	    Default: 14
326	    AllowedValues:
327	      - 0
328	      - 1
329	      - 3
330	      - 5
331	      - 7
332	      - 14
333	      - 30
334	      - 35
335	    ConstraintDescription: must be 0 (no backup) 1, 3, 5, 7, 14, 30 or 35.
336	  BackupWindow:
337	    Description: Optional preferred backup window
338	    Type: String
339	    Default: ''
340	    AllowedPattern: (?:^$|^(?:[01][0-9]|2[0-3]):[0-5][0-9]-(?:[01][0-9]|2[0-3]):[0-5][0-9]$)
341	    ConstraintDescription: must be in the format hh24:mi-hh24:mi, in UTC, not conflict with any maintenance window, and be at least 30 minutes, if specified.
342	  MaintenanceWindow:
343	    Description: Optional preferred maintenance window
344	    Type: String
345	    Default: ''
346	    AllowedPattern: (?:^$|^(?:sun|mon|tue|wed|thu|fri|sat):(?:[01][0-9]|2[0-3]):[0-5][0-9]-(?:sun|mon|tue|wed|thu|fri|sat):(?:[01][0-9]|2[0-3]):[0-5][0-9]$)
347	    ConstraintDescription: must be in the format ddd:hh24:mi-ddd:hh24:mi, in UTC, not conflict with any backup window, and be at least 30 minutes, if specified.
348	  LogRetention:
349	    Description: Number of days to retain CloudWatch Log Events
350	    Type: Number
351	    Default: 14
352	    AllowedValues:
353	      - 1
354	      - 3
355	      - 5
356	      - 7
357	      - 14
358	      - 30
359	      - 60
360	      - 90
361	      - 120
362	      - 150
363	      - 180
364	      - 365
365	      - 400
366	      - 545
367	      - 731
368	      - 1827
369	      - 3653
370	    ConstraintDescription: must be 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827 or 3653.
371	  MariaDBMasterUserName:
372	    Description: Name of the MariaDB Master User
373	    Type: String
374	    MinLength: 2
375	    MaxLength: 63
376	    Default: mariadb
377	    AllowedPattern: ^[a-z][a-z0-9]*$
378	    ConstraintDescription: must begin with a lower case letter and contain lower case alphanumeric characters.
379	  MariaDBMasterUserPassword:
380	    Description: Optional password of the MariaDB Administrator User (If unspecified, generate a random password)
381	    Type: String
382	    NoEcho: true
383	    Default: Rkalakotlal123123testeutgb
384	    AllowedPattern: (^$|(?=^.{20,32}$)(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])^.*$)
385	    ConstraintDescription: must be 20 to 32 character random string format with at least one uppercase, lowercase and digit, if specified.
386	  MariaDBDatabaseName:
387	    Description: Optional name of the MariaDB Database
388	    Type: String
389	    MaxLength: 32
390	    Default: prototype
391	    AllowedPattern: (^$|^[-a-zA-Z0-9]*$)
392	    ConstraintDescription: must contain alphanumeric characters and dashes, if specified.
393	  AdministratorNetworks:
394	    Description: Networks that can administer the Application
395	    Type: String
396	    Default: -,-,-,-,-,-,-,-
397	    ConstraintDescription: must be a comma-separated list of 8 values, each an IP CIDR range of the form x.x.x.x/x or '-'.
398	  AdministratorNetworkDescriptions:
399	    Description: Descriptions of networks that can administer the Application
400	    Type: String
401	    Default: -,-,-,-,-,-,-,-
402	    ConstraintDescription: must be a comma-separated list of 8 values, each a short text description or '-'.
403	Mappings:
404	  RegionNameMap:
405	    us-east-1:
406	      Name: Virginia
407	      Code: ue1
408	    us-east-2:
409	      Name: Ohio
410	      Code: ue2
411	    us-west-1:
412	      Name: California
413	      Code: uw1
414	    us-west-2:
415	      Name: Oregon
416	      Code: uw2
417	    ap-east-1:
418	      Name: HongKong
419	      Code: ae1
420	    ap-south-1:
421	      Name: Mumbai
422	      Code: ad1
423	    ap-northeast-2:
424	      Name: Seoul
425	      Code: an2
426	    ap-southeast-1:
427	      Name: Singapore
428	      Code: as1
429	    ap-southeast-2:
430	      Name: Sydney
431	      Code: as2
432	    ap-northeast-1:
433	      Name: Tokyo
434	      Code: an1
435	    ca-central-1:
436	      Name: Canada
437	      Code: cc1
438	    eu-central-1:
439	      Name: Frankfurt
440	      Code: ec1
441	    eu-west-1:
442	      Name: Ireland
443	      Code: ew1
444	    eu-west-2:
445	      Name: London
446	      Code: ew2
447	    eu-west-3:
448	      Name: Paris
449	      Code: ew3
450	    eu-north-1:
451	      Name: Stockholm
452	      Code: en1
453	    me-south-1:
454	      Name: Bahrain
455	      Code: ms1
456	    sa-east-1:
457	      Name: SaoPaulo
458	      Code: se1
459	  DBInstanceClassMap:
460	    Database:
461	      small: db.t3.small
462	      medium: db.t3.medium
463	      large: db.r5.large
464	      xlarge: db.r5.xlarge
465	      2xlarge: db.r5.2xlarge
466	      4xlarge: db.r5.4xlarge
467	      8xlarge: db.r5.8xlarge
468	  CPUAlarmPercentMap:
469	    Database:
470	      small: 90
471	      medium: 80
472	      large: 80
473	      xlarge: 75
474	      2xlarge: 75
475	      4xlarge: 75
476	      8xlarge: 75
477	  MemoryAlarmBytesAvailableMap:
478	    Database:
479	      small: 256000000
480	      medium: 512000000
481	      large: 768000000
482	      xlarge: 1024000000
483	      2xlarge: 2048000000
484	      4xlarge: 4096000000
485	      8xlarge: 8192000000
486	Conditions:
487	  ConfigureAccountEnvironment: !Or [ !Not [ !Equals [ !Ref AccountName, !Ref EnvironmentName ]], !Equals [ !Ref AccountName, Jumpstart ]]
488	  ConfigureGlobal: !Equals [ !Ref 'AWS::Region', us-east-1 ]
489	  ConfigureWindowsBastionsIntegration: !Not [ !Equals [ !Ref WindowsBastionsStackName, '' ]]
490	  # ConfigureDirectoryIntegration: !Not [ !Equals [ !Ref DirectoryStackName, '' ]]
491	  ConfigureActiveDirectoryIntegration: !Equals [ !Select [ 1, !Split [ '-', !Ref DirectoryStackName ]], 'ActiveDirectory' ]
492	  ConfigureMultiZone: !Not [ !Equals [ !Ref EnvironmentZones, 1 ]]
493	  ConfigureMasterUserPassword: !Not [ !Equals [ !Ref MariaDBMasterUserPassword, '' ]]
494	  GenerateMasterUserPassword: !Not [ !Condition ConfigureMasterUserPassword ]
495	  ConfigureEncryption: !Not [ !Equals [ !Ref EncryptionType, none ]]
496	  ConfigureEncryptionKey: !Equals [ !Ref EncryptionType, custom ]
497	  ConfigureBackupWindow: !Not [ !Equals [ !Ref BackupWindow, '' ]]
498	  ConfigureMaintenanceWindow: !Not [ !Equals [ !Ref MaintenanceWindow, '' ]]
499	  ConfigureDatabase: !Not [ !Equals [ !Ref MariaDBDatabaseName, '' ]]
500	  ConfigureAdministratorNetwork0: !Not [ !Equals [ !Select [ 0, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
501	  ConfigureAdministratorNetwork1: !Not [ !Equals [ !Select [ 1, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
502	  ConfigureAdministratorNetwork2: !Not [ !Equals [ !Select [ 2, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
503	  ConfigureAdministratorNetwork3: !Not [ !Equals [ !Select [ 3, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
504	  ConfigureAdministratorNetwork4: !Not [ !Equals [ !Select [ 4, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
505	  ConfigureAdministratorNetwork5: !Not [ !Equals [ !Select [ 5, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
506	  ConfigureAdministratorNetwork6: !Not [ !Equals [ !Select [ 6, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
507	  ConfigureAdministratorNetwork7: !Not [ !Equals [ !Select [ 7, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
508	Resources:
509	  Role:
510	    Type: AWS::IAM::Role
511	    Properties:
512	      Path: /
513	      AssumeRolePolicyDocument:
514	        Version: 2012-10-17
515	        Statement:
516	          - Effect: Allow
517	            Principal:
518	              Service:
519	                - monitoring.rds.amazonaws.com
520	            Action:
521	              - sts:AssumeRole
522	      ManagedPolicyArns:
523	        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
524	  # MasterUserSecret:
525	  #   Type: AWS::SecretsManager::Secret
526	  #   Properties:
527	  #     Name: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-MasterUser
528	  #     Description: !Sub Username and Password for the ${EnvironmentName} Environment ${MariaDBApplicationName} ${DatabaseComponentName} Master User
529	  #     SecretString: !If [ ConfigureMasterUserPassword, !Sub '{"username": "${MariaDBMasterUserName}", "password": "${MariaDBMasterUserPassword}"}', !Ref 'AWS::NoValue' ]
530	  #     GenerateSecretString: !If
531	  #       - GenerateMasterUserPassword
532	  #       - SecretStringTemplate: !Sub '{"username": "${MariaDBMasterUserName}"}'
533	  #         GenerateStringKey: password
534	  #         PasswordLength: 32
535	  #         ExcludePunctuation: true
536	  #       - !Ref AWS::NoValue
537	  #     Tags:
538	  #       - Key: Name
539	  #         Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-MasterUser
540	  ClientSecurityGroup:
541	    Type: AWS::EC2::SecurityGroup
542	    Properties:
543	      GroupDescription: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-ClientSecurityGroup
544	      VpcId: !ImportValue
545	        Fn::Sub: ${VPCStackName}-VPC
546	      Tags:
547	        - Key: Name
548	          Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-ClientSecurityGroup
549	  DatabaseSecurityGroup:
550	    Type: AWS::EC2::SecurityGroup
551	    Properties:
552	      GroupDescription: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DatabaseSecurityGroup
553	      VpcId: !ImportValue
554	        Fn::Sub: ${VPCStackName}-VPC
555	      SecurityGroupIngress:
556	        - IpProtocol: icmp
557	          FromPort: -1
558	          ToPort: -1
559	          CidrIp: !ImportValue
560	            Fn::Sub: ${VPCStackName}-VPCNetwork
561	          Description: VPC (ICMP)
562	        - IpProtocol: tcp
563	          FromPort: 3306
564	          ToPort: 3306
565	          SourceSecurityGroupId: !Ref ClientSecurityGroup
566	          Description: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-ClientSecurityGroup (MySQL)
567	        - !If
568	          - ConfigureWindowsBastionsIntegration
569	          - IpProtocol: tcp
570	            FromPort: 3306
571	            ToPort: 3306
572	            SourceSecurityGroupId: !ImportValue
573	              Fn::Sub: ${WindowsBastionsStackName}-InstanceSecurityGroup
574	            Description: !Sub ${WindowsBastionsStackName}-InstanceSecurityGroup (MySQL)
575	          - !Ref AWS::NoValue
576	        - !If
577	          - ConfigureAdministratorNetwork0
578	          - IpProtocol: tcp
579	            FromPort: 3306
580	            ToPort: 3306
581	            CidrIp: !Select [ 0, !Split [ ',', !Ref AdministratorNetworks ]]
582	            Description: !Sub
583	              - ${NetworkDescription} (MySQL)
584	              - NetworkDescription: !Select [ 0, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
585	          - !Ref AWS::NoValue
586	        - !If
587	          - ConfigureAdministratorNetwork1
588	          - IpProtocol: tcp
589	            FromPort: 3306
590	            ToPort: 3306
591	            CidrIp: !Select [ 1, !Split [ ',', !Ref AdministratorNetworks ]]
592	            Description: !Sub
593	              - ${NetworkDescription} (MySQL)
594	              - NetworkDescription: !Select [ 1, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
595	          - !Ref AWS::NoValue
596	        - !If
597	          - ConfigureAdministratorNetwork2
598	          - IpProtocol: tcp
599	            FromPort: 3306
600	            ToPort: 3306
601	            CidrIp: !Select [ 2, !Split [ ',', !Ref AdministratorNetworks ]]
602	            Description: !Sub
603	              - ${NetworkDescription} (MySQL)
604	              - NetworkDescription: !Select [ 2, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
605	          - !Ref AWS::NoValue
606	        - !If
607	          - ConfigureAdministratorNetwork3
608	          - IpProtocol: tcp
609	            FromPort: 3306
610	            ToPort: 3306
611	            CidrIp: !Select [ 3, !Split [ ',', !Ref AdministratorNetworks ]]
612	            Description: !Sub
613	              - ${NetworkDescription} (MySQL)
614	              - NetworkDescription: !Select [ 3, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
615	          - !Ref AWS::NoValue
616	        - !If
617	          - ConfigureAdministratorNetwork4
618	          - IpProtocol: tcp
619	            FromPort: 3306
620	            ToPort: 3306
621	            CidrIp: !Select [ 4, !Split [ ',', !Ref AdministratorNetworks ]]
622	            Description: !Sub
623	              - ${NetworkDescription} (MySQL)
624	              - NetworkDescription: !Select [ 4, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
625	          - !Ref AWS::NoValue
626	        - !If
627	          - ConfigureAdministratorNetwork5
628	          - IpProtocol: tcp
629	            FromPort: 3306
630	            ToPort: 3306
631	            CidrIp: !Select [ 5, !Split [ ',', !Ref AdministratorNetworks ]]
632	            Description: !Sub
633	              - ${NetworkDescription} (MySQL)
634	              - NetworkDescription: !Select [ 5, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
635	          - !Ref AWS::NoValue
636	        - !If
637	          - ConfigureAdministratorNetwork6
638	          - IpProtocol: tcp
639	            FromPort: 3306
640	            ToPort: 3306
641	            CidrIp: !Select [ 6, !Split [ ',', !Ref AdministratorNetworks ]]
642	            Description: !Sub
643	              - ${NetworkDescription} (MySQL)
644	              - NetworkDescription: !Select [ 6, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
645	          - !Ref AWS::NoValue
646	        - !If
647	          - ConfigureAdministratorNetwork7
648	          - IpProtocol: tcp
649	            FromPort: 3306
650	            ToPort: 3306
651	            CidrIp: !Select [ 7, !Split [ ',', !Ref AdministratorNetworks ]]
652	            Description: !Sub
653	              - ${NetworkDescription} (MySQL)
654	              - NetworkDescription: !Select [ 7, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
655	          - !Ref AWS::NoValue
656	      SecurityGroupEgress:
657	        - IpProtocol: -1
658	          CidrIp: 0.0.0.0/0
659	          Description: Global (All)
660	      Tags:
661	        - Key: Name
662	          Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DatabaseSecurityGroup
663	  HostName:
664	    Type: Custom::HostName
665	    Properties:
666	      ServiceToken: !ImportValue
667	        Fn::Sub: ${CodesStackName}-HostNameFunctionArn
668	      CompanyName: !Ref CompanyName
669	      LocationName: !Ref AWS::Region
670	      EnvironmentName: !Ref EnvironmentName
671	      ApplicationName: !Ref MariaDBApplicationName
672	      ComponentName: !Ref DatabaseComponentName
673	  ErrorLogGroup:
674	    Type: AWS::Logs::LogGroup
675	    Properties:
676	      LogGroupName: !Sub /aws/rds/cluster/${HostName}/error
677	      RetentionInDays: !Ref LogRetention
678	  GeneralLogGroup:
679	    Type: AWS::Logs::LogGroup
680	    Properties:
681	      LogGroupName: !Sub /aws/rds/cluster/${HostName}/general
682	      RetentionInDays: !Ref LogRetention
683	  SlowQueryLogGroup:
684	    Type: AWS::Logs::LogGroup
685	    Properties:
686	      LogGroupName: !Sub /aws/rds/cluster/${HostName}/slowquery
687	      RetentionInDays: !Ref LogRetention
688	  DBSubnetGroup:
689	    Type: AWS::RDS::DBSubnetGroup
690	    Properties:
691	      DBSubnetGroupDescription: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DBSubnetGroup
692	      SubnetIds:
693	        - !ImportValue
694	          Fn::Sub: ${VPCStackName}-DatabaseSubnetA
695	        - !ImportValue
696	          Fn::Sub: ${VPCStackName}-DatabaseSubnetB
697	      Tags:
698	        - Key: Name
699	          Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DBSubnetGroup
700	  DBParameterGroup:
701	    Type: AWS::RDS::DBParameterGroup
702	    Properties:
703	      Description: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DBParameterGroup
704	      Family: MariaDB10.3
705	      Tags:
706	        - Key: Name
707	          Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-DBParameterGroup
708	  DBInstance:
709	    Type: AWS::RDS::DBInstance
710	    Properties:
711	      DBInstanceIdentifier: !Ref HostName
712	      Engine: !Ref EngineType
713	      AllocatedStorage: !Ref AllocatedStorage
714	      DBInstanceClass: !Ref DBInstanceClass
715	      EngineVersion: !Ref EngineVersion
716	      DBSubnetGroupName: !Ref DBSubnetGroup
717	      DBParameterGroupName: !Ref DBParameterGroup
718	      MasterUsername: !Ref MariaDBMasterUserName
719	      MasterUserPassword: !Ref MariaDBMasterUserPassword
720	      # MasterUsername: !Sub '{{resolve:secretsmanager:${MasterUserSecret}:SecretString:username}}'
721	      # MasterUserPassword: !Sub '{{resolve:secretsmanager:${MasterUserSecret}:SecretString:password}}'
722	      StorageEncrypted: !If [ ConfigureEncryption, true, false ]
723	      KmsKeyId: !If
724	        - ConfigureEncryptionKey
725	        - !ImportValue
726	            Fn::Sub: ${KeysStackName}-RDSAlias
727	        - !Ref AWS::NoValue
728	      PreferredBackupWindow: !If [ ConfigureBackupWindow, !Ref BackupWindow, !Ref 'AWS::NoValue' ]
729	      BackupRetentionPeriod: !Ref BackupRetention
730	      PreferredMaintenanceWindow: !If [ ConfigureMaintenanceWindow, !Ref MaintenanceWindow, !Ref 'AWS::NoValue' ]
731	      EnableCloudwatchLogsExports: [ error, general, slowquery ]
732	  PrivateDBInstanceHostNameRecordSet:
733	    Type: AWS::Route53::RecordSet
734	    Properties:
735	      HostedZoneId: !ImportValue
736	        Fn::Sub: ${VPCStackName}-PrivateHostedZone
737	      Comment: !Sub Private DNS Host Name of the ${MariaDBApplicationName}-${DatabaseComponentName} DBInstance Endpoint
738	      Name: !Sub
739	        - ${HostName}.${VPCPrivateDomain}.
740	        - VPCPrivateDomain: !ImportValue
741	            Fn::Sub: ${VPCStackName}-VPCPrivateDomain
742	      Type: CNAME
743	      TTL: 900
744	      ResourceRecords:
745	        - !GetAtt DBInstance.Endpoint.Address
746	  PrivateDBInstanceServiceNameRecordSet:
747	    Type: AWS::Route53::RecordSet
748	    Properties:
749	      HostedZoneId: !ImportValue
750	        Fn::Sub: ${VPCStackName}-PrivateHostedZone
751	      Comment: !Sub Private DNS Service Name of the ${MariaDBApplicationName}-${DatabaseComponentName} DBInstance Endpoint
752	      Name: !Sub
753	        - ${MariaDBDatabaseServiceName}.${VPCPrivateDomain}.
754	        - VPCPrivateDomain: !ImportValue
755	            Fn::Sub: ${VPCStackName}-VPCPrivateDomain
756	      Type: CNAME
757	      TTL: 900
758	      ResourceRecords:
759	        - !GetAtt DBInstance.Endpoint.Address
760	Outputs:
761	  ClientSecurityGroup:
762	    Description: The Client SecurityGroup
763	    Value: !Ref ClientSecurityGroup
764	    Export:
765	      Name: !Sub ${AWS::StackName}-ClientSecurityGroup
766	  DatabaseSecurityGroup:
767	    Description: The Database SecurityGroup
768	    Value: !Ref DatabaseSecurityGroup
769	    Export:
770	      Name: !Sub ${AWS::StackName}-DatabaseSecurityGroup
771	  DBInstanceEndpoint:
772	    Description: The DBInstance Endpoint
773	    Value: !GetAtt DBInstance.Endpoint.Address
774	    Export:
775	      Name: !Sub ${AWS::StackName}-DBInstanceEndpoint
776	  PrivateDBInstanceHostName:
777	    Description: The Private DNS Host Name of the MariaDB-Database DBInstance Endpoint
778	    Value: !Sub
779	      - ${HostName}.${VPCPrivateDomain}
780	      - VPCPrivateDomain: !ImportValue
781	          Fn::Sub: ${VPCStackName}-VPCPrivateDomain
782	    Export:
783	      Name: !Sub ${AWS::StackName}-PrivateDBInstanceHostName
784	  PrivateDBInstanceServiceName:
785	    Description: The Private DNS Service Name of the MariaDB-Database DBInstance Endpoint
786	    Value: !Sub
787	      - ${MariaDBDatabaseServiceName}.${VPCPrivateDomain}
788	      - VPCPrivateDomain: !ImportValue
789	          Fn::Sub: ${VPCStackName}-VPCPrivateDomain
790	    Export:
791	      Name: !Sub ${AWS::StackName}-PrivateDBInstanceServiceName
792	  # MasterUserSecret:
793	  #   Description: The Master User Secret Name
794	  #   Value: !Sub ${EnvironmentName}-${MariaDBApplicationName}-${DatabaseComponentName}-MasterUser
795	  #   Export:
796	  #     Name: !Sub ${AWS::StackName}-MasterUserSecret
