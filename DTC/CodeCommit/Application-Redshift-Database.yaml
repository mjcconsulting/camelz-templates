AWSTemplateFormatVersion: 2010-09-09
2	Description: Application-Redshift-Database Template.
3	  This template implements an Redshift Database and related resources.
4	Metadata:
5	  AWS::CloudFormation::Interface:
6	    ParameterGroups:
7	      - Label:
8	          default: Stack Dependencies
9	        Parameters:
10	          - WindowsBastionsStackName
11	          - DirectoryStackName
12	          - VPCStackName
13	          - BucketsStackName
14	          - TopicsStackName
15	          - KeysStackName
16	          - CodesStackName
17	      - Label:
18	          default: System Configuration
19	        Parameters:
20	          - CompanyName
21	          - SystemName
22	      - Label:
23	          default: Environment Configuration
24	        Parameters:
25	          - AccountName
26	          - EnvironmentName
27	          - EnvironmentClass
28	          - EnvironmentType
29	          - EnvironmentZones
30	      - Label:
31	          default: Redshift Application Configuration
32	        Parameters:
33	          - RedshiftApplicationName
34	          - DatabaseComponentName
35	          - RedshiftDatabaseServiceName
36	      - Label:
37	          default: Cluster Configuration
38	        Parameters:
39	          - ClusterVersion
40	          - EncryptionType
41	          - SnapshotRetention
42	          - MaintenanceWindow
43	          - LogRetention
44	      - Label:
45	          default: Redshift Database Configuration
46	        Parameters:
47	          - RedshiftMasterUserName
48	          - RedshiftMasterUserPassword
49	          - RedshiftDatabaseName
50	      - Label:
51	          default: Security Configuration
52	        Parameters:
53	          - AdministratorNetworks
54	          - AdministratorNetworkDescriptions
55	    ParameterLabels:
56	      WindowsBastionsStackName:
57	        default: WindowsBastions Stack Name
58	      DirectoryStackName:
59	        default: Directory Stack Name
60	      VPCStackName:
61	        default: VPC Stack Name
62	      BucketsStackName:
63	        default: Buckets Stack Name
64	      TopicsStackName:
65	        default: Topics Stack Name
66	      KeysStackName:
67	        default: Keys Stack Name
68	      CodesStackName:
69	        default: Codes Stack Name
70	      CompanyName:
71	        default: Company Name
72	      SystemName:
73	        default: System Name
74	      AccountName:
75	        default: Account Name
76	      EnvironmentName:
77	        default: Environment Name
78	      EnvironmentClass:
79	        default: Environment Class
80	      EnvironmentType:
81	        default: Environment Type
82	      EnvironmentZones:
83	        default: Environment Zones
84	      RedshiftApplicationName:
85	        default: Redshift Application Name
86	      DatabaseComponentName:
87	        default: Database Component Name
88	      RedshiftDatabaseServiceName:
89	        default: Redshift-Database DNS Service Name
90	      ClusterVersion:
91	        default: Cluster Version
92	      EncryptionType:
93	        default: Encryption Type
94	      SnapshotRetention:
95	        default: Snapshot Retention
96	      MaintenanceWindow:
97	        default: Maintenance Window
98	      LogRetention:
99	        default: Log Retention
100	      RedshiftMasterUserName:
101	        default: Redshift Master User Name
102	      RedshiftMasterUserPassword:
103	        default: Redshift Master User Password
104	      RedshiftDatabaseName:
105	        default: Redshift Database Name
106	      AdministratorNetworks:
107	        default: Administrator Networks
108	      AdministratorNetworkDescriptions:
109	        default: Administrator Network Descriptions
110	Parameters:
111	  WindowsBastionsStackName:
112	    Description: Name of the CloudFormation Stack containing the Windows Bastions
113	    Type: String
114	    MaxLength: 64
115	    Default: UAT-WindowsBastions
116	    AllowedPattern: (^$|^[A-Z][-a-zA-Z0-9]*$)
117	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
118	  DirectoryStackName:
119	    Description: Name of the CloudFormation Stack containing the Directory Management Workstation (DirectoryService) or DomainControllers (ActiveDirectory)
120	    Type: String
121	    MaxLength: 64
122	    Default: UAT-ActiveDirectory
123	    AllowedPattern: (^$|^[A-Z][a-zA-Z0-9]*-(ActiveDirectory|DirectoryService)$)
124	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
125	  VPCStackName:
126	    Description: Name of the CloudFormation Stack containing the VPC
127	    Type: String
128	    MinLength: 2
129	    MaxLength: 64
130	    Default: UAT-VPC
131	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
132	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
133	  BucketsStackName:
134	    Description: Name of the CloudFormation Stack containing Buckets
135	    Type: String
136	    MinLength: 2
137	    MaxLength: 64
138	    Default: Buckets
139	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
140	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
141	  TopicsStackName:
142	    Description: Name of the CloudFormation Stack containing Topics
143	    Type: String
144	    MinLength: 2
145	    MaxLength: 64
146	    Default: Topics
147	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
148	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
149	  KeysStackName:
150	    Description: Name of the CloudFormation Stack containing Keys
151	    Type: String
152	    MinLength: 2
153	    MaxLength: 64
154	    Default: Keys
155	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
156	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
157	  CodesStackName:
158	    Description: Name of the CloudFormation Stack containing the Codes Resources
159	    Type: String
160	    MinLength: 2
161	    MaxLength: 64
162	    Default: Codes
163	    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
164	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
165	  CompanyName:
166	    Description: Name of the Company associated with the Stack
167	    Type: String
168	    MinLength: 2
169	    MaxLength: 32
170	    Default: DXC
171	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
172	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
173	  SystemName:
174	    Description: Name of the System associated with the Stack
175	    Type: String
176	    MinLength: 2
177	    MaxLength: 32
178	    Default: Prototype
179	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
180	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
181	  AccountName:
182	    Description: Name of the Account associated with the Stack
183	    Type: String
184	    Default: UAT
185	    AllowedValues:
186	      - Production
187	      - Staging
188	      - UAT
189	      - QA
190	      - Testing
191	      - Development
192	      - Build
193	      - Core
194	      - Recovery
195	      - Log
196	      - Management
197	      - Jumpstart
198	      - Organization
199	    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Management, Jumpstart or Organization.
200	  EnvironmentName:
201	    Description: Name of the Environment associated with the Stack
202	    Type: String
203	    Default: UAT
204	    AllowedValues:
205	      - Production
206	      - Staging
207	      - UAT
208	      - QA
209	      - Testing
210	      - Development
211	      - Build
212	      - Core
213	      - Recovery
214	      - Log
215	      - Identity
216	      - Management
217	      - Organization
218	    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Identity, Management or Organization.
219	  EnvironmentClass:
220	    Description: Class of the Environment to build. Used to select compute vs storage options in Mappings
221	    Type: String
222	    Default: compute
223	    AllowedValues:
224	      - compute
225	      - storage
226	    ConstraintDescription: must be compute or storage.
227	  EnvironmentType:
228	    Description: Type of the Environment to build. Used to select size-related options in Mappings
229	    Type: String
230	    Default: large
231	    AllowedValues:
232	      - large
233	      - 8xlarge
234	    ConstraintDescription: must be large or 8xlarge.
235	  EnvironmentNodes:
236	    Description: Number of Nodes to run
237	    Type: String
238	    Default: 4
239	    AllowedValues:
240	      - 1
241	      - 2
242	      - 4
243	      - 8
244	      - 16
245	      - 32
246	      - 64
247	      - 128
248	      - 256
249	    ConstraintDescription: must be 1, 2, 4, 8, 16, 32, 64, 128 or 256.
250	  RedshiftApplicationName:
251	    Description: Name of the Redshift Application
252	    Type: String
253	    MinLength: 2
254	    MaxLength: 32
255	    Default: Redshift
256	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
257	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
258	  DatabaseComponentName:
259	    Description: Name of the Database Component
260	    Type: String
261	    MinLength: 2
262	    MaxLength: 32
263	    Default: Database
264	    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
265	    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
266	  RedshiftDatabaseServiceName:
267	    Description: DNS Service Name of the Redshift-Database Application Component
268	    Type: String
269	    MinLength: 2
270	    MaxLength: 64
271	    Default: redshift
272	    AllowedPattern: ^[a-z][-a-z0-9]*$
273	    ConstraintDescription: must begin with a lower case letter and contain only lower case letters, numbers and dashes.
274	  ClusterVersion:
275	    Description: Version of the Redshift Cluster engine software
276	    Type: String
277	    Default: 1.0
278	    AllowedValues:
279	      - 1.0
280	    ConstraintDescription: must be 1.0.
281	  EncryptionType:
282	    Description: Type of Encryption
283	    Type: String
284	    Default: default
285	    AllowedValues:
286	      - default
287	      - custom
288	      - none
289	    ConstraintDescription: must be default, custom or none.
290	  # May want to call this BackupRetension to match RDS, not sure if there's a BackupWindow concept
291	  SnapshotRetention:
292	    Description: Number of days to retain snapshot
293	    Type: Number
294	    Default: 5
295	    AllowedValues:
296	      - 0
297	      - 5
298	      - 10
299	      - 15
300	      - 20
301	      - 25
302	      - 30
303	      - 35
304	    ConstraintDescription: must be between 0, 5, 10, 15, 20, 25, 30, 35.
305	  # Not sure if this is the right format for the value yet
306	  MaintenanceWindow:
307	    Description: Optional preferred maintenance window
308	    Type: String
309	    Default: ''
310	    AllowedPattern: (?:^$|^(?:sun|mon|tue|wed|thu|fri|sat):(?:[01][0-9]|2[0-3]):[0-5][0-9]-(?:sun|mon|tue|wed|thu|fri|sat):(?:[01][0-9]|2[0-3]):[0-5][0-9]$)
311	    ConstraintDescription: must be in the format ddd:hh24:mi-ddd:hh24:mi, in UTC, not conflict with any backup window, and be at least 30 minutes, if specified.
312	  LogRetention:
313	    Description: Number of days to retain CloudWatch Log Events
314	    Type: Number
315	    Default: 14
316	    AllowedValues:
317	      - 1
318	      - 3
319	      - 5
320	      - 7
321	      - 14
322	      - 30
323	      - 60
324	      - 90
325	      - 120
326	      - 150
327	      - 180
328	      - 365
329	      - 400
330	      - 545
331	      - 731
332	      - 1827
333	      - 3653
334	    ConstraintDescription: must be 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827 or 3653.
335	  RedshiftMasterUserName:
336	    Description: Name of the Redshift Master User
337	    Type: String
338	    MinLength: 2
339	    MaxLength: 63
340	    Default: redshift
341	    AllowedPattern: ^[a-z][a-z0-9]*$
342	    ConstraintDescription: must begin with a lower case letter and contain lower case alphanumeric characters.
343	  RedshiftMasterUserPassword:
344	    Description: Optional password of the Redshift Master User (If unspecified, generate a random password)
345	    Type: String
346	    NoEcho: true
347	    Default: Mohammedeqbal123123testeutgb
348	    AllowedPattern: (^$|(?=^.{20,32}$)(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])^.*$)
349	    ConstraintDescription: must be 20 to 32 character random string format with at least one uppercase, lowercase and digit, if specified.
350	  RedshiftDatabaseName:
351	    Description: Name of the Redshift Database
352	    Type: String
353	    MinLength: 2
354	    MaxLength: 32
355	    Default: prototype
356	    AllowedPattern: ^[-a-zA-Z0-9]*$
357	    ConstraintDescription: must contain alphanumeric characters and dashes.
358	  AdministratorNetworks:
359	    Description: Networks that can administer the Application
360	    Type: String
361	    Default: -,-,-,-,-,-,-,-
362	    ConstraintDescription: must be a comma-separated list of 8 values, each an IP CIDR range of the form x.x.x.x/x or '-'.
363	  AdministratorNetworkDescriptions:
364	    Description: Descriptions of networks that can administer the Application
365	    Type: String
366	    Default: -,-,-,-,-,-,-,-
367	    ConstraintDescription: must be a comma-separated list of 8 values, each a short text description or '-'.
368	Mappings:
369	  RegionNameMap:
370	    us-east-1:
371	      Name: Virginia
372	      Code: ue1
373	    us-east-2:
374	      Name: Ohio
375	      Code: ue2
376	    us-west-1:
377	      Name: California
378	      Code: uw1
379	    us-west-2:
380	      Name: Oregon
381	      Code: uw2
382	    ap-east-1:
383	      Name: HongKong
384	      Code: ae1
385	    ap-south-1:
386	      Name: Mumbai
387	      Code: ad1
388	    ap-northeast-2:
389	      Name: Seoul
390	      Code: an2
391	    ap-southeast-1:
392	      Name: Singapore
393	      Code: as1
394	    ap-southeast-2:
395	      Name: Sydney
396	      Code: as2
397	    ap-northeast-1:
398	      Name: Tokyo
399	      Code: an1
400	    ca-central-1:
401	      Name: Canada
402	      Code: cc1
403	    eu-central-1:
404	      Name: Frankfurt
405	      Code: ec1
406	    eu-west-1:
407	      Name: Ireland
408	      Code: ew1
409	    eu-west-2:
410	      Name: London
411	      Code: ew2
412	    eu-west-3:
413	      Name: Paris
414	      Code: ew3
415	    eu-north-1:
416	      Name: Stockholm
417	      Code: en1
418	    me-south-1:
419	      Name: Bahrain
420	      Code: ms1
421	    sa-east-1:
422	      Name: SaoPaulo
423	      Code: se1
424	  NodeTypeMap:
425	    compute:
426	      large: dc2.large
427	      8xlarge: dc2.8xlarge
428	    storage:
429	      large: ds2.xlarge
430	      8xlarge: ds2.8xlarge
431	  CPUAlarmPercentMap:
432	    Cluster:
433	      large: 80
434	      8xlarge: 75
435	  DiskAlarmPercentMap:
436	    Cluster:
437	      large: 80
438	      8xlarge: 75
439	Conditions:
440	  ConfigureAccountEnvironment: !Or [ !Not [ !Equals [ !Ref AccountName, !Ref EnvironmentName ]], !Equals [ !Ref AccountName, Jumpstart ]]
441	  ConfigureGlobal: !Equals [ !Ref 'AWS::Region', us-east-1 ]
442	  ConfigureWindowsBastionsIntegration: !Not [ !Equals [ !Ref WindowsBastionsStackName, '' ]]
443	  ConfigureDirectoryIntegration: !Not [ !Equals [ !Ref DirectoryStackName, '' ]]
444	  ConfigureActiveDirectoryIntegration: !Equals [ !Select [ 1, !Split [ '-', !Ref DirectoryStackName ]], 'ActiveDirectory' ]
445	  ConfigureMultiNode: !Not [ !Equals [ !Ref EnvironmentNodes, 1 ]]
446	  ConfigureMasterUserPassword: !Not [ !Equals [ !Ref RedshiftMasterUserPassword, '' ]]
447	  GenerateMasterUserPassword: !Not [ !Condition ConfigureMasterUserPassword ]
448	  ConfigureEncryption: !Not [ !Equals [ !Ref EncryptionType, none ]]
449	  ConfigureEncryptionKey: !Equals [ !Ref EncryptionType, custom ]
450	  ConfigureMaintenanceWindow: !Not [ !Equals [ !Ref MaintenanceWindow, '' ]]
451	  ConfigureAdministratorNetwork0: !Not [ !Equals [ !Select [ 0, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
452	  ConfigureAdministratorNetwork1: !Not [ !Equals [ !Select [ 1, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
453	  ConfigureAdministratorNetwork2: !Not [ !Equals [ !Select [ 2, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
454	  ConfigureAdministratorNetwork3: !Not [ !Equals [ !Select [ 3, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
455	  ConfigureAdministratorNetwork4: !Not [ !Equals [ !Select [ 4, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
456	  ConfigureAdministratorNetwork5: !Not [ !Equals [ !Select [ 5, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
457	  ConfigureAdministratorNetwork6: !Not [ !Equals [ !Select [ 6, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
458	  ConfigureAdministratorNetwork7: !Not [ !Equals [ !Select [ 7, !Split [ ',', !Ref AdministratorNetworks ]], '-' ]]
459	Resources:
460	  Role:
461	    Type: AWS::IAM::Role
462	    Properties:
463	      Path: /
464	      AssumeRolePolicyDocument:
465	        Version: 2012-10-17
466	        Statement:
467	          - Effect: Allow
468	            Principal:
469	              Service:
470	                - redshift.amazonaws.com
471	                #- glue.amazonaws.com
472	            Action:
473	              - sts:AssumeRole
474	  RedshiftSpectrumRole:
475	    Type: 'AWS::IAM::Role'
476	    Properties:
477	      AssumeRolePolicyDocument:
478	        Version: 2012-10-17
479	        Statement:
480	          - Effect: Allow
481	            Principal:
482	              Service: redshift.amazonaws.com
483	            Action: 'sts:AssumeRole'
484	      Path: /
485	      Policies:
486	        - PolicyName: spectrum-required-access
487	          PolicyDocument:
488	            Version: 2012-10-17
489	            Statement:
490	              - Effect: Allow
491	                Action:
492	                  - 's3:Get*'
493	                  - 's3:List*'
494	                  - 'athena:*'
495	                Resource: '*'
496	    # TODO: See the Redshift example QuickStart for a policy needed here to allow use of Redshift Spectrum with Glue
497	    #       Not adding that complexity on this first phase iteration
498	  # MasterUserSecret:
499	  #   Type: AWS::SecretsManager::Secret
500	  #   Properties:
501	  #     Name: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-MasterUser
502	  #     Description: !Sub Username and Password for the ${EnvironmentName} Environment ${RedshiftApplicationName} ${DatabaseComponentName} Master User
503	  #     SecretString: !If [ ConfigureMasterUserPassword, !Sub '{"username": "${RedshiftMasterUserName}", "password": "${RedshiftMasterUserPassword}"}', !Ref 'AWS::NoValue' ]
504	  #     GenerateSecretString: !If
505	  #       - GenerateMasterUserPassword
506	  #       - SecretStringTemplate: !Sub '{"username": "${RedshiftMasterUserName}"}'
507	  #         GenerateStringKey: password
508	  #         PasswordLength: 32
509	  #         ExcludePunctuation: true
510	  #       - !Ref AWS::NoValue
511	  #     Tags:
512	  #       - Key: Name
513	  #         Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-MasterUser
514	  ClientSecurityGroup:
515	    Type: AWS::EC2::SecurityGroup
516	    Properties:
517	      GroupDescription: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClientSecurityGroup
518	      VpcId: !ImportValue
519	        Fn::Sub: ${VPCStackName}-VPC
520	      Tags:
521	        - Key: Name
522	          Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClientSecurityGroup
523	  DatabaseSecurityGroup:
524	    Type: AWS::EC2::SecurityGroup
525	    Properties:
526	      GroupDescription: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-DatabaseSecurityGroup
527	      VpcId: !ImportValue
528	        Fn::Sub: ${VPCStackName}-VPC
529	      SecurityGroupIngress:
530	        - IpProtocol: icmp
531	          FromPort: -1
532	          ToPort: -1
533	          CidrIp: !ImportValue
534	            Fn::Sub: ${VPCStackName}-VPCNetwork
535	          Description: VPC (ICMP)
536	        - IpProtocol: tcp
537	          FromPort: 5439
538	          ToPort: 5439
539	          SourceSecurityGroupId: !Ref ClientSecurityGroup
540	          Description: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClientSecurityGroup (Redshift)
541	        - !If
542	         - ConfigureWindowsBastionsIntegration
543	         - IpProtocol: tcp
544	           FromPort: 5439
545	           ToPort: 5439
546	           SourceSecurityGroupId: !ImportValue
547	             Fn::Sub: ${WindowsBastionsStackName}-InstanceSecurityGroup
548	           Description: !Sub ${WindowsBastionsStackName}-InstanceSecurityGroup (Redshift)
549	         - !Ref AWS::NoValue
550	        - !If
551	          - ConfigureAdministratorNetwork0
552	          - IpProtocol: tcp
553	            FromPort: 5439
554	            ToPort: 5439
555	            CidrIp: !Select [ 0, !Split [ ',', !Ref AdministratorNetworks ]]
556	            Description: !Sub
557	              - ${NetworkDescription} (Redshift)
558	              - NetworkDescription: !Select [ 0, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
559	          - !Ref AWS::NoValue
560	        - !If
561	          - ConfigureAdministratorNetwork1
562	          - IpProtocol: tcp
563	            FromPort: 5439
564	            ToPort: 5439
565	            CidrIp: !Select [ 1, !Split [ ',', !Ref AdministratorNetworks ]]
566	            Description: !Sub
567	              - ${NetworkDescription} (Redshift)
568	              - NetworkDescription: !Select [ 1, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
569	          - !Ref AWS::NoValue
570	        - !If
571	          - ConfigureAdministratorNetwork2
572	          - IpProtocol: tcp
573	            FromPort: 5439
574	            ToPort: 5439
575	            CidrIp: !Select [ 2, !Split [ ',', !Ref AdministratorNetworks ]]
576	            Description: !Sub
577	              - ${NetworkDescription} (Redshift)
578	              - NetworkDescription: !Select [ 2, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
579	          - !Ref AWS::NoValue
580	        - !If
581	          - ConfigureAdministratorNetwork3
582	          - IpProtocol: tcp
583	            FromPort: 5439
584	            ToPort: 5439
585	            CidrIp: !Select [ 3, !Split [ ',', !Ref AdministratorNetworks ]]
586	            Description: !Sub
587	              - ${NetworkDescription} (Redshift)
588	              - NetworkDescription: !Select [ 3, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
589	          - !Ref AWS::NoValue
590	        - !If
591	          - ConfigureAdministratorNetwork4
592	          - IpProtocol: tcp
593	            FromPort: 5439
594	            ToPort: 5439
595	            CidrIp: !Select [ 4, !Split [ ',', !Ref AdministratorNetworks ]]
596	            Description: !Sub
597	              - ${NetworkDescription} (Redshift)
598	              - NetworkDescription: !Select [ 4, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
599	          - !Ref AWS::NoValue
600	        - !If
601	          - ConfigureAdministratorNetwork5
602	          - IpProtocol: tcp
603	            FromPort: 5439
604	            ToPort: 5439
605	            CidrIp: !Select [ 5, !Split [ ',', !Ref AdministratorNetworks ]]
606	            Description: !Sub
607	              - ${NetworkDescription} (Redshift)
608	              - NetworkDescription: !Select [ 5, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
609	          - !Ref AWS::NoValue
610	        - !If
611	          - ConfigureAdministratorNetwork6
612	          - IpProtocol: tcp
613	            FromPort: 5439
614	            ToPort: 5439
615	            CidrIp: !Select [ 6, !Split [ ',', !Ref AdministratorNetworks ]]
616	            Description: !Sub
617	              - ${NetworkDescription} (Redshift)
618	              - NetworkDescription: !Select [ 6, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
619	          - !Ref AWS::NoValue
620	        - !If
621	          - ConfigureAdministratorNetwork7
622	          - IpProtocol: tcp
623	            FromPort: 5439
624	            ToPort: 5439
625	            CidrIp: !Select [ 7, !Split [ ',', !Ref AdministratorNetworks ]]
626	            Description: !Sub
627	              - ${NetworkDescription} (Redshift)
628	              - NetworkDescription: !Select [ 7, !Split [ ',', !Ref AdministratorNetworkDescriptions ]]
629	          - !Ref AWS::NoValue
630	      SecurityGroupEgress:
631	        - IpProtocol: -1
632	          CidrIp: 0.0.0.0/0
633	          Description: Global (All)
634	      Tags:
635	        - Key: Name
636	          Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-DatabaseSecurityGroup
637	  HostName:
638	    Type: Custom::HostName
639	    Properties:
640	      ServiceToken: !ImportValue
641	        Fn::Sub: ${CodesStackName}-HostNameFunctionArn
642	      CompanyName: !Ref CompanyName
643	      LocationName: !Ref AWS::Region
644	      EnvironmentName: !Ref EnvironmentName
645	      ApplicationName: !Ref RedshiftApplicationName
646	      ComponentName: !Ref DatabaseComponentName
647	  ClusterSubnetGroup:
648	    Type: AWS::Redshift::ClusterSubnetGroup
649	    Properties:
650	      Description: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClusterSubnetGroup
651	      SubnetIds:
652	        - !ImportValue
653	          Fn::Sub: ${VPCStackName}-DatabaseSubnetA
654	        - !ImportValue
655	          Fn::Sub: ${VPCStackName}-DatabaseSubnetB
656	      Tags:
657	        - Key: Name
658	          Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClusterSubnetGroup
659	  ClusterParameterGroup:
660	    Type: AWS::Redshift::ClusterParameterGroup
661	    Properties:
662	      Description: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClusterParameterGroup
663	      ParameterGroupFamily: redshift-1.0
664	      Tags:
665	        - Key: Name
666	          Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-ClusterParameterGroup
667	  RedshiftCluster:
668	    Type: AWS::Redshift::Cluster
669	    DependsOn: RedshiftSpectrumRole
670	    Properties:
671	      ClusterIdentifier: !Ref HostName
672	      ClusterVersion: !Ref ClusterVersion
673	      ClusterType: !If [ ConfigureMultiNode, multi-node, single-node ]
674	      NodeType: !FindInMap [ NodeTypeMap, !Ref EnvironmentClass, !Ref EnvironmentType ]
675	      NumberOfNodes: !If [ ConfigureMultiNode, !Ref EnvironmentNodes, !Ref 'AWS::NoValue' ]
676	      IamRoles:
677	        - !GetAtt Role.Arn
678	        - !GetAtt RedshiftSpectrumRole.Arn
679	      ClusterSubnetGroupName: !Ref ClusterSubnetGroup
680	      VpcSecurityGroupIds:
681	        - !Ref DatabaseSecurityGroup
682	      ClusterParameterGroupName: !Ref ClusterParameterGroup
683	      MasterUsername: !Ref RedshiftMasterUserName
684	      MasterUserPassword: !Ref RedshiftMasterUserPassword
685	      #AvailabilityZone: !Select [ 0, !GetAZs '' ] # Usually/Probably don't want to set this, not an easy way to set via conditionals
686	      # MasterUsername: !Sub '{{resolve:secretsmanager:${MasterUserSecret}:SecretString:username}}'
687	      # MasterUserPassword: !Sub '{{resolve:secretsmanager:${MasterUserSecret}:SecretString:password}}'
688	      DBName: !Ref RedshiftDatabaseName
689	      Encrypted: !If [ ConfigureEncryption, true, false ]
690	      KmsKeyId: !If
691	        - ConfigureEncryptionKey
692	        - !ImportValue
693	            Fn::Sub: ${KeysStackName}-RedshiftAlias
694	        - !Ref AWS::NoValue
695	      #HsmClientCertificateIdentifier: String
696	      #HsmConfigurationIdentifier: String
697	      AutomatedSnapshotRetentionPeriod: !Ref SnapshotRetention
698	      PreferredMaintenanceWindow: !If [ ConfigureMaintenanceWindow, !Ref MaintenanceWindow, !Ref 'AWS::NoValue' ]
699	      AllowVersionUpgrade: false
700	      # TODO: Some of these remaining properties may be needed as we improve this template, but I'm not adding them on this
701	      #       First cleanup iteration
702	      #LoggingProperties:
703	      # TODO: I think we only need these if we want to implement some type of backup and restore operation, to be able to
704	      #       save the current state of Redshift in S3 when we shutdown a cluster that may only run sporadically to save
705	      #       costs, then restore and pickup where we left off when needed.
706	      #OwnerAccount: String
707	      #SnapshotClusterIdentifier: String
708	      #SnapshotIdentifier: String
709	  PrivateClusterHostNameRecordSet:
710	    Type: AWS::Route53::RecordSet
711	    Properties:
712	      HostedZoneId: !ImportValue
713	        Fn::Sub: ${VPCStackName}-PrivateHostedZone
714	      Comment: !Sub Private DNS Host Name of the ${RedshiftApplicationName}-${DatabaseComponentName} Cluster Endpoint
715	      Name: !Sub
716	        - ${HostName}.${VPCPrivateDomain}.
717	        - VPCPrivateDomain: !ImportValue
718	            Fn::Sub: ${VPCStackName}-VPCPrivateDomain
719	      Type: CNAME
720	      TTL: 900
721	      ResourceRecords:
722	        - !GetAtt RedshiftCluster.Endpoint.Address
723	  PrivateClusterServiceNameRecordSet:
724	    Type: AWS::Route53::RecordSet
725	    Properties:
726	      HostedZoneId: !ImportValue
727	        Fn::Sub: ${VPCStackName}-PrivateHostedZone
728	      Comment: !Sub Private DNS Service Name of the ${RedshiftApplicationName}-${DatabaseComponentName} Cluster Endpoint
729	      Name: !Sub
730	        - ${RedshiftDatabaseServiceName}.${VPCPrivateDomain}.
731	        - VPCPrivateDomain: !ImportValue
732	            Fn::Sub: ${VPCStackName}-VPCPrivateDomain
733	      Type: CNAME
734	      TTL: 900
735	      ResourceRecords:
736	        - !GetAtt RedshiftCluster.Endpoint.Address
737	  CPUAlarm:
738	    Type: AWS::CloudWatch::Alarm
739	    Properties:
740	      AlarmDescription: !Sub
741	        - The average CPU Utilization is greater than ${CPUAlarmPercent}% over 3 consecutive minutes
742	        - CPUAlarmPercent: !FindInMap [ CPUAlarmPercentMap, Cluster, !Ref EnvironmentType ]
743	      AlarmActions:
744	        - !ImportValue
745	          Fn::Sub: ${TopicsStackName}-AlarmsTopic
746	      InsufficientDataActions:
747	        - !ImportValue
748	          Fn::Sub: ${TopicsStackName}-AlarmsTopic
749	      Namespace: AWS/Redshift
750	      MetricName: !Sub ${RedshiftCluster}High-CPUUtilization
751	      Unit: Percent
752	      Statistic: Average
753	      Period: 60
754	      EvaluationPeriods: 3
755	      Threshold: !FindInMap [ CPUAlarmPercentMap, Cluster, !Ref EnvironmentType ]
756	      ComparisonOperator: GreaterThanThreshold
757	      Dimensions:
758	        - Name: ClusterIdentifier
759	          Value: !Ref RedshiftCluster
760	  DiskAlarm:
761	    Type: AWS::CloudWatch::Alarm
762	    Properties:
763	      AlarmDescription: !Sub
764	        - The disk space utilization is greater than ${DiskAlarmPercent}% over 3 consecutive minutes
765	        - DiskAlarmPercent: !FindInMap [ DiskAlarmPercentMap, Cluster, !Ref EnvironmentType ]
766	      AlarmActions:
767	        - !ImportValue
768	          Fn::Sub: ${TopicsStackName}-AlarmsTopic
769	      InsufficientDataActions:
770	        - !ImportValue
771	          Fn::Sub: ${TopicsStackName}-AlarmsTopic
772	      Namespace: AWS/Redshift
773	      MetricName: !Sub ${RedshiftCluster}High-PercentageDiskSpaceUsed
774	      Unit: Percent
775	      Statistic: Average
776	      Period: 60
777	      EvaluationPeriods: 3
778	      Threshold: !FindInMap [ DiskAlarmPercentMap, Cluster, !Ref EnvironmentType ]
779	      ComparisonOperator: GreaterThanThreshold
780	      Dimensions:
781	        - Name: ClusterIdentifier
782	          Value: !Ref RedshiftCluster
783	  # TODO: Remember all these Dashboards are placeholders, where you need to flesh them out with graphs you develop in
784	  #       the CloudWatch Console once you have a real database to look at and find what's important to monitor. If you
785	  #       do not put anything in here, you should remove this, as there is a cost to creating them.
786	  Dashboard:
787	    Type: AWS::CloudWatch::Dashboard
788	    Properties:
789	      DashboardName: !Sub
790	        - ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-${RegionName}
791	        - RegionName: !FindInMap [ RegionNameMap, !Ref 'AWS::Region', Name ]
792	      DashboardBody: !Sub |
793	        {
794	          "widgets" : [ {
795	            "type" : "text",
796	            "x" : 0,
797	            "y" : 0,
798	            "width" : 24,
799	            "height" : 1,
800	            "properties" : {
801	              "markdown" : "# ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}"
802	            }
803	          },
804	          {
805	            "type" : "text",
806	            "x" : 0,
807	            "y" : 1,
808	            "width" : 24,
809	            "height" : 1,
810	            "properties" : {
811	              "markdown" : "## Graphs"
812	            }
813	          },
814	          {
815	            "type" : "text",
816	            "x" : 0,
817	            "y" : 11,
818	            "width" : 24,
819	            "height" : 1,
820	            "properties" : {
821	              "markdown" : "## Alarms"
822	            }
823	          } ]
824	        }
825	Outputs:
826	  ClientSecurityGroup:
827	    Description: The Client SecurityGroup
828	    Value: !Ref ClientSecurityGroup
829	    Export:
830	      Name: !Sub ${AWS::StackName}-ClientSecurityGroup
831	  DatabaseSecurityGroup:
832	    Description: The Database SecurityGroup
833	    Value: !Ref DatabaseSecurityGroup
834	    Export:
835	      Name: !Sub ${AWS::StackName}-DatabaseSecurityGroup
836	  ClusterEndpoint:
837	    Description: The Cluster Endpoint
838	    Value: !GetAtt RedshiftCluster.Endpoint.Address
839	    Export:
840	      Name: !Sub ${AWS::StackName}-ClusterEndpoint
841	  PrivateClusterHostName:
842	    Description: The Private DNS Host Name of the Redshift-Database Cluster Endpoint
843	    Value: !Sub
844	      - ${HostName}.${VPCPrivateDomain}
845	      - VPCPrivateDomain: !ImportValue
846	          Fn::Sub: ${VPCStackName}-VPCPrivateDomain
847	    Export:
848	      Name: !Sub ${AWS::StackName}-PrivateClusterHostName
849	  PrivateClusterServiceName:
850	    Description: The Private DNS Service Name of the Redshift-Database Cluster Endpoint
851	    Value: !Sub
852	      - ${RedshiftDatabaseServiceName}.${VPCPrivateDomain}
853	      - VPCPrivateDomain: !ImportValue
854	          Fn::Sub: ${VPCStackName}-VPCPrivateDomain
855	    Export:
856	      Name: !Sub ${AWS::StackName}-PrivateClusterServiceName
857	  DatabaseName:
858	    Description: The Database Name
859	    Value: !Ref RedshiftDatabaseName
860	    Export:
861	      Name: !Sub ${AWS::StackName}-DatabaseName
862	  RedshiftClusterIAMRole:
863	    Description: IAM Role that the cluster and db users can assume. Required to setup
864	      Redshift Spectrum
865	    Value: !GetAtt RedshiftSpectrumRole.Arn
866	  # MasterUserSecret:
867	  #   Description: The Master User Secret Name
868	  #   Value: !Sub ${EnvironmentName}-${RedshiftApplicationName}-${DatabaseComponentName}-MasterUser
869	  #   Export:
870	  #     Name: !Sub ${AWS::StackName}-MasterUserSecret
